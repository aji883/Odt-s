<%- include('partials/header', { title: title, bodyClass: bodyClass }) %>

<a href="javascript:history.back()" class="btn-back">‚Üê</a>

<div class="transaction-container">
    <div class="transaction-header">
        <h1>Detail Transaksi</h1>
        <span class="offer-status status-<%= transaction.status %>"><%= transaction.status %></span>
    </div>

    <div class="transaction-grid">
        <div class="transaction-item">
            <h3>Item yang Ditawar</h3>
            <div class="item-card">
                <img src="/<%= transaction.item_image %>" alt="<%= transaction.item_title %>" class="item-image">
                <h3><a href="/items/<%= transaction.item_main_id %>"><%= transaction.item_title %></a></h3>
                <p>Oleh: <%= transaction.owner_username %></p>
            </div>
        </div>

        <div class="transaction-item">
            <% if (transaction.type === 'swap') { %>
                <h3>Item yang Ditawarkan (oleh <%= transaction.proposer_username %>)</h3>
                
                <% if (transaction.offered_item_id) { %>
                    <div class="item-card">
                        <img src="/<%= transaction.offered_item_image %>" alt="<%= transaction.offered_item_title %>" class="item-image">
                        <h3><a href="/items/<%= transaction.offered_item_id %>"><%= transaction.offered_item_title %></a></h3>
                    </div>
                <% } else if (isProposer) { %>
                    <p>Anda harus memilih item dari LemaRI-ku untuk ditukarkan:</p>
                    <form action="/transactions/<%= transaction.id %>/select-swap" method="POST">
                        <div class="form-group">
                            <label for="offeredItemId">Pilih Item Anda</label>
                            <select id="offeredItemId" name="offeredItemId" class="form-control">
                                <option value="">-- Pilih Item --</option>
                                <% itemsForSwap.forEach(item => { %>
                                    <option value="<%= item.id %>"><%= item.title %></option>
                                <% }) %>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Tawarkan Item Ini</button>
                    </form>
                <% } else { %>
                    <div class="item-card" style="height: 300px; display: grid; place-items: center; background: var(--bg-light, #222);">
                        <p>Menunggu penawar memilih item...</p>
                    </div>
                <% } %>
            
            <% } else { %>
                <h3>Ringkasan Pembelian</h3>
                <div class="transaction-details-box">
                    <p><strong>Penawar:</strong> <%= transaction.proposer_username %></p>
                    <p><strong>Jenis:</strong> Pembelian</p>
                    <p><strong>Status:</strong> <span class="status-<%= transaction.status %>"><%= transaction.status %></span></p>
                    <hr>
                    <p class="price"><strong>Harga Item:</strong> Rp <%= (transaction.agreed_price || transaction.item_price).toLocaleString('id-ID') %></p>
                    <hr>
                    <p><strong>Alamat Pengiriman:</strong><br><%= transaction.shipping_address %></p>
                    <p><strong>Metode Pembayaran:</strong> <%= transaction.payment_method %></p>
                </div>
            <% } %>
        </div>
    </div>
    <% if (transaction.message) { %>
        <div class="transaction-message">
            <h4>Pesan Awal dari <%= transaction.proposer_username %>:</h4>
            <p>"<%= transaction.message %>"</p>
        </div>
    <% } %>

    <% if (isOwner && transaction.status === 'pending') { %>
        <div class="transaction-actions">
            <h3>Konfirmasi Tawaran</h3>
            <% if (transaction.type === 'buy' || (transaction.type === 'swap' && transaction.offered_item_id)) { %>
                <p>Beri tahu <strong><%= transaction.proposer_username %></strong> apakah Anda menerima tawaran ini.</p>
                <form action="/transactions/<%= transaction.id %>/accept" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-accept">‚úÖ Terima Tawaran</button>
                </form>
                <form action="/transactions/<%= transaction.id %>/reject" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-reject">‚ùå Tolak Tawaran</button>
                </form>
            <% } else { %>
                <p>Menunggu penawar memilih item barter...</p>
            <% } %>
        </div>
    <% } %>

    <% if (isProposer) { %>
        <% if (transaction.status === 'accepted') { %>
            <div class="transaction-actions received-action">
                <h3>Konfirmasi Penerimaan</h3>
                <p>Tawaran Anda telah diterima oleh <strong><%= transaction.owner_username %></strong>. Apakah Anda sudah menerima item ini? Klik untuk menyelesaikan transaksi.</p>
                <form action="/transactions/<%= transaction.id %>/complete" method="POST">
                    <button type="submit" class="btn btn-accept">üì¶ Pesanan Diterima</button>
                </form>
            </div>
        <% } else if (transaction.status === 'completed') { %>
            <div class="transaction-status-info status-completed">
                <h3>Transaksi Selesai</h3>
                <p>Anda telah mengonfirmasi penerimaan item ini.</p>
            </div>
        <% } else if (transaction.status === 'rejected') { %>
            <div class="transaction-status-info status-rejected">
                <h3>Tawaran Ditolak</h3>
                <p>Maaf, tawaran Anda ditolak oleh <strong><%= transaction.owner_username %></strong>.</p>
            </div>
        <% } else if (transaction.status === 'cancelled') { %>
             <div class="transaction-status-info status-cancelled">
                <h3>Tawaran Dibatalkan</h3>
                <p>Anda telah membatalkan tawaran ini.</p>
            </div>
        <% } else if (transaction.status === 'pending' && transaction.type === 'swap' && !transaction.offered_item_id) { %>
            <div class="transaction-status-info status-pending">
                <h3>Lanjutkan Tawaran</h3>
                <p>Anda harus memilih item dari LemaRI-ku Anda untuk ditukarkan.</p>
            </div>
        <% } else if (transaction.status === 'pending') { %>
            <div class="transaction-status-info status-pending">
                <h3>Menunggu Konfirmasi</h3>
                <p>Menunggu respon dari <strong><%= transaction.owner_username %></strong>.</p>
            </div>
        <% } %>
    <% } %>

</div>
<%- include('partials/footer') %>

<style>
    .transaction-header { display: flex; justify-content: space-between; align-items: center; }
    .transaction-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 2rem; 
        margin: 2rem 0; 
    }
    .transaction-item h3 { color: #fff; }
    
    .transaction-details-box {
        background: var(--glass-bg, rgba(255, 255, 255, 0.1));
        padding: 1.5rem;
        border-radius: 10px;
        border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.2));
    }
    .transaction-details-box p { font-size: 1.1em; margin: 0.5rem 0; }
    .transaction-details-box hr { border-color: var(--glass-border, rgba(255, 255, 255, 0.2)); }
    .transaction-details-box .price { font-size: 1.3em; font-weight: bold; color: #fff; }
    
    .transaction-message { background: var(--bg-light, #222); padding: 1rem; border-radius: 5px; margin-top: 1rem; }
    .transaction-message.info { background: #3a3a5a; }
    
    .transaction-actions { background: var(--glass-bg, rgba(255, 255, 255, 0.1)); padding: 1.5rem; border-radius: 10px; border: 1px solid var(--glass-border); margin-top: 2rem; }
    .transaction-actions h3 { margin-top: 0; }

    /* Kotak Status untuk Penawar */
    .transaction-status-info {
        margin-top: 2rem;
        padding: 1.5rem;
        border-radius: 10px;
        border: 1px solid;
    }
    .transaction-status-info h3 { margin-top: 0; margin-bottom: 0.5rem; color: #fff; }
    .transaction-status-info p { margin-bottom: 0; color: #eee; line-height: 1.6; }

    .btn-accept { background-color: #2ecc71; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    .btn-reject { background-color: #e74c3c; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }

    .offer-status { padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: bold; text-transform: uppercase; color: #fff; }
    .status-pending { background-color: #f39c12; border-color: #f39c12; }
    .status-accepted { background-color: #2ecc71; border-color: #2ecc71; }
    .status-rejected { background-color: #e74c3c; border-color: #e74c3c; }
    .status-cancelled { background-color: #95a5a6; border-color: #95a5a6; }
    .status-completed { background-color: #3498db; border-color: #3498db; }
    
    /* Warna border untuk kotak status */
    .transaction-status-info.status-accepted { background-color: rgba(46, 204, 113, 0.2); border-color: #2ecc71; }
    .transaction-status-info.status-rejected { background-color: rgba(231, 76, 60, 0.2); border-color: #e74c3c; }
    .transaction-status-info.status-pending { background-color: rgba(243, 156, 18, 0.2); border-color: #f39c12; }
    .transaction-status-info.status-cancelled { background-color: rgba(149, 165, 166, 0.2); border-color: #95a5a6; }
    .transaction-status-info.status-completed { background-color: rgba(52, 152, 219, 0.2); border-color: #3498db; }

    .transaction-actions.received-action {
        background: rgba(46, 204, 113, 0.1);
        border: 1px solid #2ecc71;
    }
</style>